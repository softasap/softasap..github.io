



<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>Using Vault to Secure Your Deployment Secrets</title>
  

  <link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,700,100%7CRoboto:400,700,300,100' rel='stylesheet' type='text/css'>

<!-- Bootstrap and Font Awesome css -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<link rel="stylesheet" href="https://cdn.rawgit.com/konpa/devicon/df6431e323547add1b4cf45992913f15286456d3/devicon.min.css">

<link href=".././_static/css/bootstrap.min.css" rel="stylesheet">

<!-- Theme stylesheet -->
<link href=".././_static/css/style.blue.css" rel="stylesheet" id="theme-stylesheet">

<!-- owl carousel css -->

<link href=".././_static/css/owl.carousel.css" rel="stylesheet">
<link href=".././_static/css/owl.theme.css" rel="stylesheet">

<!-- CSS Animations -->
<link href=".././_static/css/animate.css" rel="stylesheet">

<!-- CSS Animations -->
<link href=".././_static/css/custom.css" rel="stylesheet">

<!-- Mordernizr -->
<script src=".././_static/js/modernizr-2.6.2.min.js"></script>

<!-- Responsivity for older IE -->
<!--[if lt IE 9]>
<script src=".././_static/js/respond.min.js"></script>
<![endif]-->
<!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f)}})(document,window.mixpanel||[]);
mixpanel.init("d8c471ba307480a6d444f5a567340548");</script><!-- end Mixpanel -->
</head>

<body data-spy="scroll" data-target="#navigation" data-offset="120" class="__blog_2017_02_vault">

    <!-- *** NAVBAR *** -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation" id="navbar">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand scrollTo" href="/#intro">Get your software deployed in a quick and robust way</a>
        </div>

        <div class="navbar-collapse collapse" id="navigation">

            <ul class="nav navbar-nav navbar-right">
                <li><a href="/services.html">Services</a>
                </li>
                <li><a href="/#devops">Devops recipes</a>
                </li>
                <li><a href="/#contact">Contact</a>
                </li>
                <li><a href="/blog/archive.html">Blog</a>
                </li>
            </ul>
        </div>
        <!--/.nav-collapse -->

    </div>
</div>
<!-- /#navbar -->
    <!-- *** NAVBAR END *** -->

    <div id="all">
      <div class="mb20 block-text">
        


<div class="section section__top">
<div class="row">
  <div class="col-sm-1 mb20">
  </div>
  <div class="col-sm-8 mb20">
    


<div class="section">
  <span style="float: left;">
  
  
  <a href="2017-01-keys.html">
    <i class="fa fa-arrow-circle-left"></i>
    Linux Quick Tip: Adding GitHub Keys as Authorized Keys
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  
  <a href="2017-03-projectdocs.html">
    Documentation as a project
    <i class="fa fa-arrow-circle-right"></i>
  </a>
  </span>
  
</div>

  </div>
  <div class="col-sm-3 mb20">
  </div>
</div>
<div class="row">
<div class="col-sm-1 mb20">
</div>
<div class="col-sm-8 mb20">
  

    

    <div>
  
  <i class="fa fa-calendar"></i>
    Feb 11, 2017
  
</div>

  

  

  
  <span><i class="fa-fw fa fa-folder-open"></i>
    
      
      <a href="category/knowledge-sharing.html">knowledge sharing</a>
      
    </span>
  

  
  <span><i class="fa-fw fa fa-tags"></i>
      
    
      
      <a href="tag/deployment.html">deployment</a>,
      
    
      
      <a href="tag/process.html">process</a>,
      
    
      
      <a href="tag/devops.html">devops</a>
      
    </span>
  
  

  <div class="section" id="using-vault-to-secure-your-deployment-secrets">
<h1>Using Vault to Secure Your Deployment Secrets<a class="headerlink" href="#using-vault-to-secure-your-deployment-secrets" title="Permalink to this headline">¶</a></h1>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p><em>&#8220;Don’t Check Passwords into Source Control or Hard-Code Them in Your
Application Operations staff will remove your eyes with a spoon if they
catch you doing this. Don’t give them the pleasure.</em></p>
<p><em>Passwords should always be entered by the user performing the
deployment. There are several acceptable ways to handle authentication
for a multilayer system. You could use certificates, a directory
service, or a single sign-on system.&#8221;</em></p>
<p>This quote is taken from Chapter 2 of the <a class="reference external" href="http://martinfowler.com/books/continuousDelivery.html">Continuous Delivery: Reliable
Software Releases Through Build, Test, And Deployment
Automation</a>
(Addison-Wesley Signature Series (Fowler)) book by David Farley and Jez
Humble.</p>
<p><a class="reference external" href="https://vaultproject.io/">Vault</a> by HashiCorp is one of the tools
that might provide an acceptable level of security for DevOps engineers,
and it is suitable for enterprise scenarios as well as for smaller teams
like startups.</p>
</div>
<div class="section" id="challenges-to-address">
<h2>Challenges to Address<a class="headerlink" href="#challenges-to-address" title="Permalink to this headline">¶</a></h2>
<p>At the end of the article, we should be able to</p>
<ul class="simple">
<li>install vault on an Ubuntu 14.04 :TS server</li>
<li>initialize vault</li>
<li>store secrets in vault</li>
<li>access secrets in vault</li>
</ul>
</div>
</div>
<div class="section" id="installing">
<h1>Installing<a class="headerlink" href="#installing" title="Permalink to this headline">¶</a></h1>
<p>Formal installation steps are covered by this article:
<a class="reference external" href="https://vaultproject.io/docs/install/">https://vaultproject.io/docs/install/</a> For purposes of the demo article
let me provide semi automated script, that installs vault <em>0.1.2</em> into
/opt/vault_0.1.2 folder , configures it to listen on localhost port
8200 and registers it as a service called vault-server</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>#!/bin/sh

VAULT_VERSION=${VAULT_VERSION-0.1.2}
VAULT_PATH=/opt/vault_$VAULT_VERSION
UNAME=`uname -m`

if [ &quot;$UNAME&quot; != &quot;x86_64&quot; ]; then
  PLATFORM=386
else
  PLATFORM=amd64
fi


if [ &quot;$(id -u)&quot; != &quot;0&quot; ]; then
    echo &quot;Installation must be done under sudo&quot;
    exit 1
fi

test -x $VAULT_PATH/vault
if [ $? -eq 0 ]; then
    echo vault already installed
    exit 1
fi

apt-get install -y curl unzip

rm /opt/vault_${VAULT_VERSION}_linux_${PLATFORM}.zip

curl -L &quot;https://dl.bintray.com/mitchellh/vault/vault_${VAULT_VERSION}_linux_${PLATFORM}.zip&quot; &gt; /opt/vault_${VAULT_VERSION}_linux_${PLATFORM}.zip

mkdir -p $VAULT_PATH

unzip /opt/vault_${VAULT_VERSION}_linux_${PLATFORM}.zip -d $VAULT_PATH

chmod 0755 $VAULT_PATH/vault
chown root:root $VAULT_PATH/vault

echo create config

cat &lt;&lt;EOF &gt;$VAULT_PATH/vault-config.hcl
backend &quot;file&quot; {
  path = &quot;$VAULT_PATH/storage&quot;
}

listener &quot;tcp&quot; {
  address = &quot;127.0.0.1:8200&quot;
  tls_disable = 1
}
EOF

echo create run script
cat &lt;&lt;EOF &gt;$VAULT_PATH/vault-server
#!/bin/sh
if [ -z \$1 ]
then
  echo syntax: vault-server /PATH/TO/VAULT/HCL/CONFIG optional_flags
  exit 1
fi
BASEDIR=\$(dirname \$0)
cd \$BASEDIR
./vault server -config=\$1 \$2 \$3 \$4 \$5 \$6 \$7 \$8 \$9
EOF

chmod 0755 $VAULT_PATH/vault-server
chown root:root $VAULT_PATH/vault-server

echo create upstart script
cat &lt;&lt;EOF &gt;/etc/init/vault-server.conf
description &quot;Vault server&quot;
start on runlevel [2345]
stop on runlevel [!2345]
respawn
script
  # Make sure to use all our CPUs, because Vault can block a scheduler thread
  export GOMAXPROCS=`nproc`
  exec $VAULT_PATH/vault-server ${VAULT_PATH}/vault-config.hcl &gt;&gt;/var/log/vault.log 2&gt;&amp;1
end script
EOF

service vault-server start
cat /var/log/vault.log
</pre></div>
</div>
<p>Check the installation:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">vault_status</span><span class="o">.</span><span class="n">sh</span>
<span class="n">Error</span> <span class="n">checking</span> <span class="n">seal</span> <span class="n">status</span><span class="p">:</span> <span class="n">Error</span> <span class="n">making</span> <span class="n">API</span> <span class="n">request</span><span class="o">.</span>

<span class="n">URL</span><span class="p">:</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8200</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">seal</span><span class="o">-</span><span class="n">status</span>
<span class="n">Code</span><span class="p">:</span> <span class="mf">400.</span> <span class="n">Errors</span><span class="p">:</span>

<span class="o">*</span> <span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">initialized</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">Message</span></code> means that vault was installed and configured correctly, but
needs to be initialized. Initialization happens once the server is
started against a new backend that has never been used with Vault
before. During initialization, the encryption keys are generated, unseal
keys are created, and the initial root token is setup. To initialize
Vault use <code class="docutils literal"><span class="pre">vault</span> <span class="pre">init</span></code>. This is an unauthenticated request, but it
only works on brand new Vaults with no data</p>
<p>Let&#8217;s init. Important influences on security include the number of key
shares to generate and the number of key shares provided to unlock the
seal.</p>
<p>How does this work? The key used to encrypt the data is also encrypted
using 256-bit AES in GCM mode. This is known as the master key. The
encrypted encryption key is stored in the backend storage. The master
key is then split using Shamir&#8217;s Secret Sharing. Shamir&#8217;s Secret Sharing
ensures that no single person (including Vault) has the ability to
decrypt the data. To decrypt the data, a threshold number of keys (by
default three, but configurable) are required to unseal the Vault. These
keys are expected to be with three different places / individuals.</p>
<p>This acts like a secure bank cell where a bank personnel has one key and
you have another one. In Vault, you might have a much higher level of
security.</p>
<p>For demo purposes, I will use a single key only.</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>./vault_init.sh
The number of key shares to split the master key into: 1
The number of key shares required to reconstruct the master key 1
Key 1: af29615803fc23334c3a93f8ad58353b587f50eb0399d23a6950721cbae94948
Initial Root Token: 98df443c-65ee-d843-7f4b-9af8c426128a

Vault initialized with 1 keys and a key threshold of 1!

Please securely distribute the above keys. Whenever a Vault server
is started, it must be unsealed with 1 (the threshold) of the
keys above (any of the keys, as long as the total number equals
the threshold).

Vault does not store the original master key. If you lose the keys
above such that you no longer have the minimum number (the
threshold), then your Vault will not be able to be unsealed.
</pre></div>
</div>
<p>Initial Root Token must be immediately saved in a secure location.</p>
<div class="section" id="using-vault">
<h2>Using Vault<a class="headerlink" href="#using-vault" title="Permalink to this headline">¶</a></h2>
<div class="section" id="unsealing">
<h3>Unsealing<a class="headerlink" href="#unsealing" title="Permalink to this headline">¶</a></h3>
<p>When a Vault server is started, it starts in a sealed state. Unsealing
is the process of constructing the master key necessary to read the
decryption key to decrypt the data, thus prior to unsealing, almost no
operations are possible with Vault.</p>
<p>Let&#8217;s unseal:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">vault_</span> <span class="n">unseal</span> <span class="n">af29615803fc23334c3a93f8ad58353b587f50eb0399d23a6950721cbae94948</span>
<span class="n">Sealed</span><span class="p">:</span> <span class="n">false</span>
<span class="n">Key</span> <span class="n">Shares</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Key</span> <span class="n">Threshold</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Unseal</span> <span class="n">Progress</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Note if you had a higher threshold set, all the key holders would need
to perform the unseal operation with their parts of the key. This
provides an additional level of security for accessing data.</p>
</div>
<div class="section" id="authorization">
<h3>Authorization<a class="headerlink" href="#authorization" title="Permalink to this headline">¶</a></h3>
<p>In order to continue working with Vault, you should first identify
yourself. Let&#8217;s use auth command to do this by providing our initial
root token</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>./vault_ auth 98df443c-65ee-d843-7f4b-9af8c426128a
Successfully authenticated! The policies that are associated
with this token are listed below:

root
</pre></div>
</div>
</div>
<div class="section" id="policies">
<h3>Policies<a class="headerlink" href="#policies" title="Permalink to this headline">¶</a></h3>
<p>Access control policies in Vault control what a user can access. When
initializing Vault, only the &#8220;root&#8221; policy is present. It gives a
superuser access to everything in Vault.</p>
<p>As we plan to store secrets for multiple projects, we should be able to
clearly separate access to secrets that belong to different projects.
And this is where policies do their job.</p>
<p>Policies in Vault are formatted with HCL. HCL is a human-readable
configuration format that is also JSON-compatible, so you can use JSON
as well. An example policy is shown below:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="s2">&quot;secret/project/name&quot;</span> <span class="p">{</span>
  <span class="n">policy</span> <span class="o">=</span> <span class="s2">&quot;read&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This specifies a path we have in some tree structure, and wildcards are
supported. If you provide access to specific parts of the tree, you also
provide the same access to all subnodes, unless you override it.</p>
<p>Policy is registered with the <em>policy-write</em> command</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">vault_</span> <span class="n">policy</span><span class="o">-</span><span class="n">write</span> <span class="n">demo</span> <span class="n">demo</span><span class="o">.</span><span class="n">hcl</span>
<span class="n">vault</span> <span class="n">policy</span><span class="o">-</span><span class="n">write</span> <span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8200</span> <span class="n">demo</span> <span class="n">demo</span><span class="o">.</span><span class="n">hcl</span>
<span class="n">Policy</span> <span class="s1">&#39;demo&#39;</span> <span class="n">written</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="deployment-tokens">
<h3>Deployment Tokens<a class="headerlink" href="#deployment-tokens" title="Permalink to this headline">¶</a></h3>
<p>Now it is time to create a deployment token. In our case, this token
that would allow us to read the secret deployment value from Vault, and
does not have any additional privileges except this.</p>
<p>In order to do so, we create tokens with the policy command</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">vault_create_token_with_policy</span><span class="o">.</span><span class="n">sh</span> <span class="n">demo</span>
<span class="n">vault</span> <span class="n">token</span><span class="o">-</span><span class="n">create</span> <span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8200</span> <span class="o">-</span><span class="n">policy</span><span class="o">=</span><span class="n">demo</span>
<span class="mi">4</span><span class="n">d79adad</span><span class="o">-</span><span class="n">a4ec</span><span class="o">-</span><span class="n">de8b</span><span class="o">-</span><span class="mi">3</span><span class="n">f85</span><span class="o">-</span><span class="mi">5467</span><span class="n">b3e8536a</span>
</pre></div>
</div>
</div>
<div class="section" id="storing-data">
<h3>Storing Data<a class="headerlink" href="#storing-data" title="Permalink to this headline">¶</a></h3>
<p>Now it is time to store some secrets for deployment. For the purposes of
the demo, let it be some API key and private key used for deployment.</p>
<p>Here&#8217;s the command used to write the secrets</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>./vault_write.sh secret/project/name/apikey BLABLABLA
vault write -address=http://localhost:8200 secret/project/name/apikey value=BLABLABLA
Success! Data written to: secret/project/name/apikey

./vault_write_file.sh secret/project/name/id_rsa ./demo_rsa
Success! Data written to: secret/project/name/id_rsa
</pre></div>
</div>
<div class="section" id="important">
<h4>Important<a class="headerlink" href="#important" title="Permalink to this headline">¶</a></h4>
<p>Binary file storing is not supported as for now, but you always can
store base64 encoded file, like the MIME attachments are stored in
mails. Fortunately, for most deployments we have API keys and private
keys that are text files.</p>
</div>
</div>
<div class="section" id="retrieving-the-data">
<h3>Retrieving the Data<a class="headerlink" href="#retrieving-the-data" title="Permalink to this headline">¶</a></h3>
<p>There are two ways to access your data. First is using the Vault client
itself</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">vault_read</span><span class="o">.</span><span class="n">sh</span> <span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">apikey</span>
<span class="n">vault</span> <span class="n">read</span> <span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8200</span> <span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">apikey</span>
<span class="n">Key</span>             <span class="n">Value</span>
<span class="n">lease_id</span>        <span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">apikey</span><span class="o">/</span><span class="n">a74dd189</span><span class="o">-</span><span class="n">de4b</span><span class="o">-</span><span class="mi">1</span><span class="n">c98</span><span class="o">-</span><span class="n">ba24</span><span class="o">-</span><span class="mi">6</span><span class="n">b29258c511b</span>
<span class="n">lease_duration</span>  <span class="mi">2592000</span>
<span class="n">lease_renewable</span> <span class="n">false</span>
<span class="n">value</span>           <span class="n">BLABLABLA</span>

<span class="o">./</span><span class="n">vault_read</span><span class="o">.</span><span class="n">sh</span> <span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">id_rsa</span>
<span class="n">vault</span> <span class="n">read</span> <span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8200</span> <span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">id_rsa</span>
<span class="n">Key</span>             <span class="n">Value</span>
<span class="n">lease_id</span>        <span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">id_rsa</span><span class="o">/</span><span class="mi">204</span><span class="n">ba657</span><span class="o">-</span><span class="mi">9648</span><span class="o">-</span><span class="mi">4</span><span class="n">fa5</span><span class="o">-</span><span class="mi">8</span><span class="n">f82</span><span class="o">-</span><span class="n">ede992a054b4</span>
<span class="n">lease_duration</span>  <span class="mi">2592000</span>
<span class="n">lease_renewable</span> <span class="n">false</span>
<span class="n">value</span>           <span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEpgIBAAKCAQEApiLCR2sgf5unedMk1a2maL22PsoPwQWpGTDFZgCvhSVWvnBs</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Second is using an HTTP-based API. For that scenario, you will need to
authorize via the deployment token we allocated previously.</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">vault_curl</span><span class="o">.</span><span class="n">sh</span> <span class="mi">4</span><span class="n">d79adad</span><span class="o">-</span><span class="n">a4ec</span><span class="o">-</span><span class="n">de8b</span><span class="o">-</span><span class="mi">3</span><span class="n">f85</span><span class="o">-</span><span class="mi">5467</span><span class="n">b3e8536a</span> <span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">apikey</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">H</span> <span class="n">X</span><span class="o">-</span><span class="n">Vault</span><span class="o">-</span><span class="n">Token</span><span class="p">:</span> <span class="mi">4</span><span class="n">d79adad</span><span class="o">-</span><span class="n">a4ec</span><span class="o">-</span><span class="n">de8b</span><span class="o">-</span><span class="mi">3</span><span class="n">f85</span><span class="o">-</span><span class="mi">5467</span><span class="n">b3e8536a</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8200</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">apikey</span>
<span class="p">{</span><span class="s2">&quot;lease_id&quot;</span><span class="p">:</span><span class="s2">&quot;secret/project/name/apikey/2189c6c4-1fa7-0f4d-2598-bded29a4ce6b&quot;</span><span class="p">,</span><span class="s2">&quot;renewable&quot;</span><span class="p">:</span><span class="n">false</span><span class="p">,</span><span class="s2">&quot;lease_duration&quot;</span><span class="p">:</span><span class="mi">2592000</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">:{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;BLABLABLA&quot;</span><span class="p">},</span><span class="s2">&quot;auth&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">}</span>

<span class="o">./</span><span class="n">vault_curl</span><span class="o">.</span><span class="n">sh</span> <span class="mi">4</span><span class="n">d79adad</span><span class="o">-</span><span class="n">a4ec</span><span class="o">-</span><span class="n">de8b</span><span class="o">-</span><span class="mi">3</span><span class="n">f85</span><span class="o">-</span><span class="mi">5467</span><span class="n">b3e8536a</span> <span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">id_rsa</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">H</span> <span class="n">X</span><span class="o">-</span><span class="n">Vault</span><span class="o">-</span><span class="n">Token</span><span class="p">:</span> <span class="mi">4</span><span class="n">d79adad</span><span class="o">-</span><span class="n">a4ec</span><span class="o">-</span><span class="n">de8b</span><span class="o">-</span><span class="mi">3</span><span class="n">f85</span><span class="o">-</span><span class="mi">5467</span><span class="n">b3e8536a</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8200</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">secret</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">name</span><span class="o">/</span><span class="n">id_rsa</span>
<span class="p">{</span><span class="s2">&quot;lease_id&quot;</span><span class="p">:</span><span class="s2">&quot;secret/project/name/id_rsa/ec509e1f-09a7-6aee-54e2-f3364720c7de&quot;</span><span class="p">,</span><span class="s2">&quot;renewable&quot;</span><span class="p">:</span><span class="n">false</span><span class="p">,</span><span class="s2">&quot;lease_duration&quot;</span><span class="p">:</span><span class="mi">2592000</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">:{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;-----BEGIN RSA PRIVATE KEY-----</span><span class="se">\n</span><span class="s2">MIIEpgI......-----END RSA PRIVATE KEY-----&quot;</span><span class="p">},</span><span class="s2">&quot;auth&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="securing-vault-http-api">
<h2>Securing Vault HTTP API<a class="headerlink" href="#securing-vault-http-api" title="Permalink to this headline">¶</a></h2>
<p>Vault supports HTTPS itself, but I believe for production deployment it
would be better to hide it behind web server as a proxy.</p>
<p>Below is an example of nginx configuration</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>server {
  listen 443 ssl;
  server_name vault.YOURDOMAIN.COM;

  ssl_certificate YOUR_SSL_CERTIFICATE.crt;
  ssl_certificate_key YOUR_SSL_CERTIFICATE_KEY.key;

  location / {
    proxy_pass http://127.0.0.1:8200;
    proxy_set_header Host $host;
    expires -1;
  }

  #ssl config per https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

  ssl_ciphers &quot;EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA256:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EDH+aRSA+AESGCM:EDH+aRSA+SHA256:EDH+aRSA:EECDH:!aNULL:!eNULL:!MEDIUM:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS:!RC4:!SEED&quot;;
  ssl_prefer_server_ciphers on;

  ssl_dhparam dhparam.pem;

  #only supported since 1.3.7
  ssl_stapling on;
  ssl_stapling_verify on;

  # Optimize SSL by caching session parameters for 10 minutes. This cuts down on the number of expensive SSL handshakes.
  # The handshake is the most CPU-intensive operation, and by default it is re-negotiated on every new/parallel connection.
  # By enabling a cache (of type &quot;shared between all Nginx workers&quot;), we tell the client to re-use the already negotiated state.
  # Further optimization can be achieved by raising keepalive_timeout, but that shouldn&#39;t be done unless you serve primarily HTTPS.
  ssl_session_cache    shared:SSL:10m; # a 1mb cache can hold about 4000 sessions, so we can hold 40000 sessions
  ssl_session_timeout  10m;

  add_header Strict-Transport-Security max-age=63072000;
  add_header X-Frame-Options DENY;
  add_header X-Content-Type-Options nosniff;
}
</pre></div>
</div>
</div>
<div class="section" id="the-code-in-action">
<h2>The Code in Action<a class="headerlink" href="#the-code-in-action" title="Permalink to this headline">¶</a></h2>
<p>This code can be downloaded from repository
<a class="reference external" href="https://github.com/Voronenko/hashi_vault_utils">https://github.com/Voronenko/hashi_vault_utils</a></p>
<p>Some files just help using the existing vault functionality in a more
handy way:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">vault_status.sh</span></code> - gets the status of the vault</li>
<li><code class="docutils literal"><span class="pre">vault_policy.sh</span></code> - lists known policies, or shows details of the
policy provided as a first parameter</li>
<li><code class="docutils literal"><span class="pre">vault_create_token_with_policy.sh</span></code> creates and returns a token
with policy provided as a first parameter.</li>
<li><code class="docutils literal"><span class="pre">vault_read.sh</span></code> reads a secret by key (first parameter)</li>
<li><code class="docutils literal"><span class="pre">vault_write.sh</span></code> writes secrets by keys (first parameter) and sets
their values (second parameter)</li>
<li><code class="docutils literal"><span class="pre">vault_write\_file.sh</span></code> writes secrets by keys (first parameter) and
stores the contents of text files provided as the second parameter</li>
<li><code class="docutils literal"><span class="pre">vault_curl.sh</span></code> can be used to test HTTP API. The first parameter
is the access token, while the second parameter is the secret key to
read.</li>
</ul>
</div>
<div class="section" id="points-of-interest">
<h2>Points of interest<a class="headerlink" href="#points-of-interest" title="Permalink to this headline">¶</a></h2>
<p>This covers only very basic aspects to start using Vault in your
organization, but could be a nice first step to move forward.</p>
</div>
</div>

</div>
<div class="col-sm-3 mb20">
  
  <h3><a href="tag.html">Tags</a></h3>
  <ul class="ablog-cloud">
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="tag/ansible.html">ansible</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/ansible-container.html">ansible-container</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/aws.html">aws</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/cloud.html">cloud</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/continuous-delivery.html">continuous-delivery</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-4">
        <a href="tag/deployment.html">deployment</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/development.html">development</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-5">
        <a href="tag/devops.html">devops</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="tag/docker.html">docker</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/esxi.html">esxi</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/java.html">java</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/jenkins.html">jenkins</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/jumpbox.html">jumpbox</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/lamp.html">lamp</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/letsencrypt.html">letsencrypt</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/process.html">process</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="tag/rnd.html">rnd</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/ruby.html">ruby</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="tag/tip.html">tip</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/vagrant.html">vagrant</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/vpc.html">vpc</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="tag/workplace.html">workplace</a></li>
      
    
  </ul>


  
  <h3><a href="category.html">Categories</a></h3>
  <ul class="ablog-categories">
  
    
    <li><a href="category/field-notes.html">field notes (4)</a></li>
    
  
    
    <li><a href="category/from-oops-to-devops.html">from-oops-to-devops (9)</a></li>
    
  
    
    <li><a href="category/knowledge-sharing.html">knowledge sharing (3)</a></li>
    
  
  </ul>


  
  <h3><a href="archive.html">Archives</a></h3>
  <ul>
  
    
    <li><a href="2017.html">2017 (6)</a></li>
    
  
    
    <li><a href="2016.html">2016 (10)</a></li>
    
  
  </ul>


</div>
</div>
</div>




  
  <div class="section">
    <div class="row">
      <div class="col-sm-1 mb20">
      </div>
      <div class="col-sm-8 mb20">
        


<div class="section">
  <span style="float: left;">
  
  
  <a href="2017-01-keys.html">
    <i class="fa fa-arrow-circle-left"></i>
    Linux Quick Tip: Adding GitHub Keys as Authorized Keys
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  
  <a href="2017-03-projectdocs.html">
    Documentation as a project
    <i class="fa fa-arrow-circle-right"></i>
  </a>
  </span>
  
</div>

      </div>
      <div class="col-sm-3 mb20">
      </div>
    </div>
  </div>
  
  </div>
  

      </div>

    </div>
    <!-- /#all -->

<!-- #### JAVASCRIPT FILES ### -->

<!-- js base -->
<script src=".././_static/js/jquery-1.11.0.min.js"></script>
<script src=".././_static/js/bootstrap.min.js"></script>


<!-- for demo purpose -->
<script src=".././_static/js/jquery.cookie.js"></script>

<!-- waypoints for scroll spy -->
<script src=".././_static/js/waypoints.min.js"></script>

<!-- masonry layout -->
<script src=".././_static/js/masonry.pkgd.min.js"></script>

<!-- owl carousel -->
<script src=".././_static/js/owl.carousel.min.js"></script>


<!-- jQuery scroll to -->
<script src=".././_static/js/jquery.scrollTo.min.js"></script>

<!-- main js file -->
<script src=".././_static/js/front.js"></script>


</body>

</html>